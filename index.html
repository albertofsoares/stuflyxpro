<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando...</title>
    <!-- Favicon dinâmico será injetado via JS -->
    <link id="dynamic-favicon" rel="icon" href="data:;base64,iVBORw0KGgo=">

    <!-- Tailwind CSS (Estilização Rápida e Responsiva) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Quill.js (Editor de Texto Rico) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- FontAwesome (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configurações Estéticas (Netflix Vibe) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #141414; /* Netflix Black */
            color: #e5e5e5;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #e50914; }

        /* Animações */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Utilitários do Player */
        .player-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 50; display: flex; flex-direction: column;
        }
        
        /* Ajuste do Quill no modo Dark */
        .ql-toolbar { background: #e5e5e5; border-radius: 8px 8px 0 0; }
        .ql-container { background: #fff; color: #000; border-radius: 0 0 8px 8px; height: 200px; }

        /* Card da Aula */
        .lesson-card {
            transition: transform 0.3s, z-index 0.3s;
        }
        .lesson-card:hover {
            transform: scale(1.05);
            z-index: 10;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Container Principal da Aplicação -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- O conteúdo será injetado aqui via JavaScript -->
        <div class="flex items-center justify-center h-screen">
            <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-red-600"></div>
        </div>
    </div>

    <!-- Módulo Principal da Aplicação -->
    <script type="module">
        // =================================================================
        // 1. CONFIGURAÇÃO E IMPORTAÇÕES (FIREBASE)
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            orderBy, 
            setDoc,
            getDoc,
            where
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCRnLXwHj_jAuZZcICdwGnqgqtBnvNIsMQ",
            authDomain: "studyflixpro.firebaseapp.com",
            projectId: "studyflixpro",
            storageBucket: "studyflixpro.firebasestorage.app",
            messagingSenderId: "658926227849",
            appId: "1:658926227849:web:1805d4ebbaf14046c85158"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // =================================================================
        // 2. ESTADO GLOBAL DA APLICAÇÃO (State Management)
        // =================================================================
        const state = {
            user: null,
            isAdmin: false,
            lessons: [],
            config: { siteName: "StudyFlix", favicon: "" },
            currentLesson: null,
            progress: {}, // { lessonId: timestamp }
            speechSynth: window.speechSynthesis,
            ytPlayer: null
        };

        // Cache de elementos DOM
        const root = document.getElementById('app');
        
        // Editor Quill Global
        let quillEditor = null;

        // =================================================================
        // 3. LÓGICA DE NEGÓCIO (Business Logic)
        // =================================================================

        // --- Autenticação ---
        const login = async (email, password) => {
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert("Erro ao logar: " + error.message);
            }
        };

        const register = async (email, password) => {
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert("Conta criada com sucesso! Bem-vindo.");
                // O onAuthStateChanged detectará o login automaticamente
            } catch (error) {
                alert("Erro ao criar conta: " + error.message);
            }
        };

        const logout = () => signOut(auth);

        // --- Banco de Dados: Aulas ---
        const fetchLessons = async () => {
            const q = query(collection(db, "lessons"), orderBy("season"), orderBy("episode"));
            const snapshot = await getDocs(q);
            state.lessons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp(); // Re-renderiza quando dados chegam
        };

        const saveLesson = async (lessonData, id = null) => {
            try {
                if (id) {
                    await updateDoc(doc(db, "lessons", id), lessonData);
                } else {
                    await addDoc(collection(db, "lessons"), lessonData);
                }
                await fetchLessons();
                closeModal();
            } catch (e) {
                console.error("Erro ao salvar aula:", e);
                alert("Erro ao salvar.");
            }
        };

        const deleteLesson = async (id) => {
            if(confirm("Tem certeza que deseja excluir esta aula?")) {
                await deleteDoc(doc(db, "lessons", id));
                await fetchLessons();
            }
        };

        // --- Banco de Dados: Configurações Globais ---
        const fetchConfig = async () => {
            try {
                const docRef = doc(db, "config", "global");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    state.config = docSnap.data();
                    document.title = state.config.siteName || "StudyFlix";
                    if(state.config.favicon) document.getElementById('dynamic-favicon').href = state.config.favicon;
                }
            } catch (e) {
                console.log("Configuração padrão usada.");
            }
        };

        const saveConfig = async (name, favicon) => {
            await setDoc(doc(db, "config", "global"), { siteName: name, favicon: favicon });
            state.config = { siteName: name, favicon: favicon };
            document.title = name;
            document.getElementById('dynamic-favicon').href = favicon;
            alert("Configurações salvas!");
        };

        // --- Progresso do Usuário ---
        const fetchProgress = async () => {
            if (!state.user) return;
            const q = query(collection(db, "progress"), where("userId", "==", state.user.uid));
            const snapshot = await getDocs(q);
            const progressData = {};
            snapshot.forEach(doc => {
                progressData[doc.data().lessonId] = true;
            });
            state.progress = progressData;
        };

        const markLessonComplete = async (lessonId) => {
            if (!state.user) return;
            // Salva apenas se ainda não estiver salvo
            if (!state.progress[lessonId]) {
                await addDoc(collection(db, "progress"), {
                    userId: state.user.uid,
                    lessonId: lessonId,
                    completedAt: new Date()
                });
                state.progress[lessonId] = true;
                // Atualiza visualmente se estiver na home (opcional)
            }
        };

        // --- Utilitários ---
        const extractVideoID = (url) => {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        // =================================================================
        // 4. RENDERIZAÇÃO (UI Components)
        // =================================================================

        const renderApp = () => {
            root.innerHTML = '';
            
            if (!state.user) {
                renderLogin();
                return;
            }

            if (state.currentLesson) {
                renderPlayer(); // Modo Imersivo
            } else {
                renderHome();   // Dashboard
            }
        };

        // --- TELA DE LOGIN ---
        const renderLogin = () => {
            root.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-black bg-opacity-90" style="background-image: url('https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bcae-07a3f8dc141a/f6d7434e-d6de-4185-a6d4-c77a2d08737b/US-en-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg'); background-blend-mode: overlay;">
                    <div class="bg-black bg-opacity-80 p-12 rounded-lg shadow-lg max-w-md w-full">
                        <h1 class="text-4xl font-bold text-red-600 mb-8 text-center">StudyFlix</h1>
                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label class="block text-gray-400 text-sm mb-2">Email</label>
                                <input type="email" id="email" class="w-full p-3 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="voce@exemplo.com" required>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-sm mb-2">Senha</label>
                                <input type="password" id="password" class="w-full p-3 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="******" required>
                            </div>
                            <div class="flex flex-col gap-3">
                                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded transition duration-200">Entrar</button>
                                <button type="button" id="btnRegister" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded transition duration-200">Criar Nova Conta</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Listener do Login (Submit do form)
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                login(document.getElementById('email').value, document.getElementById('password').value);
            });

            // Listener do Cadastro (Clique do botão)
            document.getElementById('btnRegister').addEventListener('click', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                if(!email || !password) {
                    alert("Preencha email e senha para criar uma conta.");
                    return;
                }
                register(email, password);
            });
        };

        // --- DASHBOARD (HOME) ---
        const renderHome = () => {
            // Agrupar aulas por Série (Matéria)
            const groupedLessons = state.lessons.reduce((acc, lesson) => {
                if (!acc[lesson.series]) acc[lesson.series] = [];
                acc[lesson.series].push(lesson);
                return acc;
            }, {});

            // Header HTML
            let html = `
                <nav class="bg-black bg-opacity-90 fixed w-full z-40 px-8 py-4 flex justify-between items-center border-b border-gray-800">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl font-bold text-red-600 tracking-tighter">${state.config.siteName}</span>
                    </div>
                    <div class="flex gap-4 items-center">
                        ${state.isAdmin ? `<button id="btnAdmin" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">Admin</button>` : ''}
                        ${state.isAdmin ? `<button id="btnConfig" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm"><i class="fas fa-cog"></i></button>` : ''}
                        <button id="btnLogout" class="text-gray-400 hover:text-white text-sm">Sair</button>
                    </div>
                </nav>
                
                <div class="pt-24 pb-12 px-8 fade-in">
            `;

            // Renderizar linhas por Matéria
            if (Object.keys(groupedLessons).length === 0) {
                html += `<div class="text-center mt-20 text-gray-500">Nenhuma aula cadastrada ainda.</div>`;
            } else {
                for (const [series, lessons] of Object.entries(groupedLessons)) {
                    html += `
                        <div class="mb-8">
                            <h2 class="text-xl font-semibold text-white mb-4 pl-2 border-l-4 border-red-600">${series}</h2>
                            <div class="flex overflow-x-auto space-x-4 pb-4 scrollbar-hide">
                    `;
                    
                    // Ordenar por Temporada e Episódio
                    lessons.sort((a, b) => (a.season - b.season) || (a.episode - b.episode));

                    lessons.forEach(lesson => {
                        const isCompleted = state.progress[lesson.id];
                        const thumbnail = `https://img.youtube.com/vi/${extractVideoID(lesson.videoUrl)}/mqdefault.jpg`;
                        
                        html += `
                            <div class="lesson-card flex-none w-64 bg-gray-900 rounded-md overflow-hidden relative shadow-lg group" onclick="window.startLesson('${lesson.id}')">
                                <div class="relative h-36">
                                    <img src="${thumbnail}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">
                                    <div class="absolute bottom-2 right-2 bg-black bg-opacity-70 text-xs px-2 py-1 rounded">T${lesson.season}:E${lesson.episode}</div>
                                    ${isCompleted ? '<div class="absolute top-2 right-2 text-green-500 bg-black bg-opacity-70 rounded-full p-1"><i class="fas fa-check"></i></div>' : ''}
                                </div>
                                <div class="p-3">
                                    <h3 class="font-bold text-sm text-gray-200 truncate">${lesson.title}</h3>
                                    <div class="w-full bg-gray-800 h-1 mt-3 rounded-full overflow-hidden">
                                        <div class="h-full bg-red-600" style="width: ${isCompleted ? '100%' : '0%'}"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `</div></div>`;
                }
            }

            html += `</div>`; // Fechamento do container
            
            // Injeção de Modais (Escondidos por padrão)
            html += getAdminModalTemplate();
            html += getConfigModalTemplate();

            root.innerHTML = html;

            // Event Listeners
            document.getElementById('btnLogout').onclick = logout;
            if(state.isAdmin) {
                document.getElementById('btnAdmin').onclick = () => openAdminModal();
                document.getElementById('btnConfig').onclick = () => openConfigModal();
            }
        };

        // --- PLAYER IMERSIVO (Lógica Principal) ---
        const renderPlayer = () => {
            const lesson = state.currentLesson;
            const videoId = extractVideoID(lesson.videoUrl);

            root.innerHTML = `
                <div class="player-overlay fade-in">
                    <!-- Controle Superior -->
                    <div class="absolute top-4 right-4 z-[60]">
                        <button onclick="window.closePlayer()" class="text-white bg-red-600 hover:bg-red-700 rounded-full w-12 h-12 flex items-center justify-center shadow-lg transform hover:scale-110 transition">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <!-- ESTÁGIO 1: VÍDEO -->
                    <div id="videoStage" class="flex-1 w-full h-full flex items-center justify-center bg-black">
                        <div id="youtube-player"></div>
                    </div>

                    <!-- ESTÁGIO 2: LEITURA & AUDIO (Inicialmente Oculto) -->
                    <div id="textStage" class="hidden flex-1 w-full h-full bg-gray-900 text-gray-200 p-8 overflow-y-auto flex flex-col items-center">
                        <div class="max-w-3xl w-full py-10">
                            <h1 class="text-3xl font-bold text-white mb-6">${lesson.title}</h1>
                            <div class="prose prose-invert prose-lg mb-10 border-b border-gray-700 pb-8">
                                ${lesson.content}
                            </div>
                            
                            <div class="flex items-center justify-center gap-4 bg-gray-800 p-4 rounded-lg">
                                <div class="animate-pulse w-3 h-3 bg-red-500 rounded-full"></div>
                                <span class="text-sm font-semibold uppercase tracking-widest text-gray-400">Leitura Automática em Progresso</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Iniciar YouTube Player
            if (window.YT) {
                initYTPlayer(videoId);
            } else {
                // Carregar API se não existir
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                window.onYouTubeIframeAPIReady = () => initYTPlayer(videoId);
            }
        };

        // Funções de Controle do Player
        let ytPlayerInstance = null;
        
        const initYTPlayer = (videoId) => {
            ytPlayerInstance = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        };

        const onPlayerStateChange = (event) => {
            // 0 = Ended
            if (event.data === 0) {
                transitionToText();
            }
        };

        const transitionToText = () => {
            const videoStage = document.getElementById('videoStage');
            const textStage = document.getElementById('textStage');
            
            if(videoStage) videoStage.classList.add('hidden');
            if(textStage) textStage.classList.remove('hidden');

            // Iniciar TTS
            startTTS(state.currentLesson.content);
        };

        const startTTS = (htmlContent) => {
            // Cancelar falas anteriores
            state.speechSynth.cancel();

            // Extrair texto limpo do HTML
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = htmlContent;
            const text = tempDiv.textContent || tempDiv.innerText || "";

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.rate = 1.1; // Um pouco mais rápido para melhor fluidez

            utterance.onend = () => {
                finishLesson();
            };

            state.speechSynth.speak(utterance);
        };

        const finishLesson = async () => {
            // 1. Salvar progresso
            await markLessonComplete(state.currentLesson.id);

            // 2. Achar próxima aula
            const allLessons = state.lessons.filter(l => l.series === state.currentLesson.series);
            allLessons.sort((a, b) => (a.season - b.season) || (a.episode - b.episode));
            
            const currentIndex = allLessons.findIndex(l => l.id === state.currentLesson.id);
            const nextLesson = allLessons[currentIndex + 1];

            if (nextLesson) {
                // Flash message ou transição visual
                alert("Aula concluída! Iniciando próxima aula...");
                state.currentLesson = nextLesson;
                renderPlayer(); // Reinicia o ciclo
            } else {
                alert("Parabéns! Você finalizou esta matéria.");
                closePlayer();
            }
        };

        // Torna acessível globalmente
        window.closePlayer = () => {
            if(state.speechSynth) state.speechSynth.cancel();
            state.currentLesson = null;
            renderHome();
        };

        window.startLesson = (id) => {
            state.currentLesson = state.lessons.find(l => l.id === id);
            renderPlayer();
        };

        // =================================================================
        // 5. PAINEL ADMIN E MODAIS
        // =================================================================

        const getAdminModalTemplate = () => `
            <div id="adminModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
                <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-800 z-10">
                        <h2 class="text-2xl font-bold text-white">Gerenciar Aulas</h2>
                        <button onclick="window.closeModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div class="p-6">
                        <!-- Formulário -->
                        <form id="lessonForm" class="space-y-4 mb-8 bg-gray-700 p-4 rounded">
                            <input type="hidden" id="lessonId">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input id="series" type="text" placeholder="Matéria (ex: Algoritmos)" class="bg-gray-800 text-white p-2 rounded border border-gray-600 w-full" required>
                                <input id="season" type="number" placeholder="Temporada/Unidade" class="bg-gray-800 text-white p-2 rounded border border-gray-600 w-full" required>
                                <input id="episode" type="number" placeholder="Episódio" class="bg-gray-800 text-white p-2 rounded border border-gray-600 w-full" required>
                            </div>
                            <input id="title" type="text" placeholder="Título da Aula" class="bg-gray-800 text-white p-2 rounded border border-gray-600 w-full" required>
                            <input id="videoUrl" type="text" placeholder="URL do YouTube" class="bg-gray-800 text-white p-2 rounded border border-gray-600 w-full" required>
                            
                            <!-- Quill Wrapper -->
                            <div class="bg-white text-black rounded">
                                <div id="editor-container"></div>
                            </div>

                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" onclick="resetForm()" class="px-4 py-2 bg-gray-600 rounded text-white">Limpar</button>
                                <button type="submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-white font-bold">Salvar Aula</button>
                            </div>
                        </form>

                        <!-- Lista Simples de Aulas -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-gray-300">
                                <thead class="text-xs uppercase bg-gray-900 text-gray-400">
                                    <tr>
                                        <th class="p-3">Matéria</th>
                                        <th class="p-3">T:E</th>
                                        <th class="p-3">Título</th>
                                        <th class="p-3 text-right">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="adminLessonList" class="divide-y divide-gray-700">
                                    <!-- Preenchido via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const getConfigModalTemplate = () => `
            <div id="configModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
                <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">Configurações do Site</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1">Nome do Site</label>
                            <input id="confSiteName" type="text" class="w-full bg-gray-700 p-2 rounded text-white" value="${state.config.siteName}">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">URL do Favicon</label>
                            <input id="confFavicon" type="text" class="w-full bg-gray-700 p-2 rounded text-white" value="${state.config.favicon || ''}">
                        </div>
                        <button onclick="window.saveGlobalConfig()" class="w-full bg-blue-600 py-2 rounded font-bold mt-4">Salvar Configurações</button>
                        <button onclick="document.getElementById('configModal').classList.add('hidden')" class="w-full bg-gray-600 py-2 rounded mt-2">Cancelar</button>
                    </div>
                </div>
            </div>
        `;

        // Lógica do Modal Admin
        window.openAdminModal = () => {
            const modal = document.getElementById('adminModal');
            modal.classList.remove('hidden');
            
            // Renderizar lista
            const tbody = document.getElementById('adminLessonList');
            tbody.innerHTML = state.lessons.map(l => `
                <tr class="hover:bg-gray-700">
                    <td class="p-3">${l.series}</td>
                    <td class="p-3">${l.season}:${l.episode}</td>
                    <td class="p-3 font-semibold text-white">${l.title}</td>
                    <td class="p-3 text-right space-x-2">
                        <button onclick="window.editLesson('${l.id}')" class="text-blue-400"><i class="fas fa-edit"></i></button>
                        <button onclick="window.removeLesson('${l.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            // Init Quill se não existir
            if(!quillEditor) {
                quillEditor = new Quill('#editor-container', {
                    theme: 'snow',
                    placeholder: 'Conteúdo de texto da aula...',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline', 'strike'],
                            ['blockquote', 'code-block'],
                            [{ 'header': 1 }, { 'header': 2 }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'color': [] }, { 'background': [] }],
                            ['clean']
                        ]
                    }
                });
            }

            // Bind Form Submit
            const form = document.getElementById('lessonForm');
            form.onsubmit = (e) => {
                e.preventDefault();
                const data = {
                    series: document.getElementById('series').value,
                    season: parseInt(document.getElementById('season').value),
                    episode: parseInt(document.getElementById('episode').value),
                    title: document.getElementById('title').value,
                    videoUrl: document.getElementById('videoUrl').value,
                    content: quillEditor.root.innerHTML,
                    updatedAt: new Date()
                };
                const id = document.getElementById('lessonId').value;
                saveLesson(data, id || null);
            };
        };

        window.closeModal = () => {
            document.getElementById('adminModal').classList.add('hidden');
            window.resetForm();
        };

        window.resetForm = () => {
            document.getElementById('lessonForm').reset();
            document.getElementById('lessonId').value = "";
            if(quillEditor) quillEditor.root.innerHTML = "";
        };

        window.editLesson = (id) => {
            const lesson = state.lessons.find(l => l.id === id);
            if(!lesson) return;
            
            document.getElementById('lessonId').value = lesson.id;
            document.getElementById('series').value = lesson.series;
            document.getElementById('season').value = lesson.season;
            document.getElementById('episode').value = lesson.episode;
            document.getElementById('title').value = lesson.title;
            document.getElementById('videoUrl').value = lesson.videoUrl;
            quillEditor.root.innerHTML = lesson.content;
        };

        window.removeLesson = (id) => deleteLesson(id);

        // Lógica Config
        window.openConfigModal = () => document.getElementById('configModal').classList.remove('hidden');
        window.saveGlobalConfig = () => {
            const name = document.getElementById('confSiteName').value;
            const fav = document.getElementById('confFavicon').value;
            saveConfig(name, fav);
            document.getElementById('configModal').classList.add('hidden');
        };

        // =================================================================
        // 6. INICIALIZAÇÃO
        // =================================================================
        onAuthStateChanged(auth, async (user) => {
            state.user = user;
            if (user) {
                // Verificação simples de admin (Segurança Real deve ser feita nas Security Rules do Firestore)
                state.isAdmin = user.email.includes("@userpro"); 
                
                await Promise.all([fetchConfig(), fetchLessons(), fetchProgress()]);
            } else {
                renderLogin();
            }
        });

    </script>
</body>
</html>
