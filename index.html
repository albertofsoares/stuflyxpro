<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando...</title>
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS BASE --- */
        :root {
            --primary: #e50914;
            --bg: #141414;
            --surface: #1f1f1f;
            --text: #ffffff;
            --text-sec: #b3b3b3;
            --success: #46d369;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); color: var(--text); overflow-x: hidden; }

        /* --- UTILITÁRIOS --- */
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #f40612; }
        .btn-sec { background: rgba(109, 109, 110, 0.7); color: white; }
        .btn-warning { background: #e5a109; color: black; }

        /* --- LOGIN --- */
        #login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bcae-07a3f8dc141a/f6d7434e-d6de-4185-a6d4-c77a2d08737b/BR-pt-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg'); background-size: cover; }
        .login-box { background: rgba(0,0,0,0.85); padding: 60px 68px 40px; border-radius: 4px; width: 100%; max-width: 450px; }
        .login-box input { width: 100%; padding: 16px; background: #333; border: none; border-radius: 4px; color: white; margin-bottom: 16px; }

        /* --- NAVBAR --- */
        nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 4%; background: linear-gradient(to bottom, rgba(0,0,0,0.9) 10%, transparent); position: fixed; top: 0; width: 100%; z-index: 100; }
        .logo { font-size: 28px; color: var(--primary); font-weight: bold; text-transform: uppercase; text-shadow: 2px 2px 4px #000; }
        
        /* --- HOME --- */
        #app-content { padding-top: 80px; }
        .hero-banner { height: 50vh; display: flex; flex-direction: column; justify-content: center; padding-left: 4%; background: radial-gradient(circle at top right, rgba(20,20,20,0), var(--bg)), url('https://images.unsplash.com/photo-1516321318423-f06f85e504b3?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80'); background-size: cover; margin-bottom: 20px; }
        
        .category-row { margin-bottom: 30px; padding-left: 4%; }
        .category-title { font-size: 1.2rem; color: #e5e5e5; margin-bottom: 10px; border-left: 3px solid var(--primary); padding-left: 10px; }
        .row-scroller { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; scrollbar-width: none; }
        .row-scroller::-webkit-scrollbar { display: none; }

        .episode-card { flex: 0 0 auto; width: 260px; height: 146px; background: #333; border-radius: 4px; cursor: pointer; position: relative; overflow: hidden; transition: transform 0.3s; }
        .episode-card:hover { transform: scale(1.05); z-index: 10; }
        .episode-card img { width: 100%; height: 100%; object-fit: cover; }
        .episode-info { position: absolute; bottom: 0; width: 100%; padding: 8px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); font-size: 0.85rem; }
        
        /* Barra de Progresso (Watched) */
        .progress-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: #555; display: none; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; }
        .watched .progress-bar-container { display: block; }
        .watched .progress-bar-fill { width: 100%; }
        .watched img { opacity: 0.5; filter: grayscale(80%); } /* Visual de "já vi" */
        .watched::after { content: '\f00c'; font-family: 'Font Awesome 5 Free'; font-weight: 900; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--primary); font-size: 2rem; opacity: 0.8; }

        /* --- PLAYER AUTOMÁTICO --- */
        #player-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #000; z-index: 2000; display: flex; flex-direction: column; }
        .player-header { padding: 20px; position: absolute; top: 0; width: 100%; z-index: 10; display: flex; justify-content: space-between; pointer-events: none; }
        .player-header button { pointer-events: auto; }

        #video-stage { flex: 1; display: flex; align-items: center; justify-content: center; background: black; }
        /* O iframe do YouTube será injetado aqui */

        #text-stage { display: flex; flex-direction: column; height: 100%; background: #141414; padding: 80px 15% 40px; }
        #text-content { flex: 1; overflow-y: auto; font-size: 1.5rem; line-height: 1.8; color: #ddd; text-align: justify; padding-right: 15px; font-family: 'Georgia', serif; }
        
        .reading-controls { background: #222; padding: 15px; margin-top: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .speed-control { display: flex; align-items: center; gap: 10px; }

        /* --- ADMIN --- */
        #admin-panel { padding: 40px 10%; background: #1a1a1a; min-height: 100vh; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; }
        input, select { width: 100%; padding: 10px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; }
        #editor-container { background: white; color: black; height: 300px; margin-bottom: 20px; }
        
        .admin-list-item { background: #252525; padding: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid var(--primary); }
        .admin-actions button { margin-left: 5px; padding: 5px 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h1 style="text-align: center;">Entrar</h1>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-pass" placeholder="Senha" required>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Acessar Plataforma</button>
                <button type="button" class="btn btn-sec" style="width: 100%; margin-top: 10px;" onclick="window.createTempUser()">Criar Conta (Admin)</button>
            </form>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-screen" class="hidden">
        
        <nav id="navbar">
            <div class="logo" id="site-logo-text">STUDYFLIX</div>
            <div>
                <button id="admin-btn" class="hidden btn btn-sec" onclick="window.router('admin')">Admin</button>
                <button class="btn btn-primary" onclick="window.router('home')">Início</button>
                <button class="btn btn-sec" onclick="window.doLogout()">Sair</button>
            </div>
        </nav>

        <!-- HOME -->
        <div id="home-view">
            <div class="hero-banner">
                <h1 style="font-size: 3rem; text-shadow: 2px 2px 4px black;">Meus Estudos</h1>
                <p>Selecione uma matéria para continuar de onde parou.</p>
            </div>
            <div id="categories-container"></div>
        </div>

        <!-- ADMIN -->
        <div id="admin-view" class="hidden">
            <div id="admin-panel">
                <h2>Gerenciar Aulas (CRUD)</h2>
                
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 40px;">
                    <h3 id="form-title">Nova Aula</h3>
                    <input type="hidden" id="edit-id"> <!-- ID oculto para edição -->
                    
                    <div class="form-grid">
                        <div class="full-width">
                            <label>Série (Matéria)</label>
                            <input type="text" id="ep-series" placeholder="Ex: Sistemas Operacionais">
                        </div>
                        <div>
                            <label>Temporada (Unidade)</label>
                            <input type="number" id="ep-season" placeholder="1">
                        </div>
                        <div>
                            <label>Episódio (Aula)</label>
                            <input type="number" id="ep-number" placeholder="1">
                        </div>
                        <div class="full-width">
                            <label>Título da Aula</label>
                            <input type="text" id="ep-title">
                        </div>
                        <div class="full-width">
                            <label>Link YouTube (URL Completa)</label>
                            <input type="text" id="ep-video" placeholder="https://www.youtube.com/watch?v=...">
                        </div>
                        <div class="full-width">
                            <label>Resumo (Leitura Automática)</label>
                            <div id="editor-container"></div>
                        </div>
                    </div>
                    <button id="btn-save" class="btn btn-primary" onclick="window.saveEpisode()">Publicar Aula</button>
                    <button id="btn-cancel" class="btn btn-sec hidden" onclick="window.resetForm()">Cancelar Edição</button>
                </div>

                <h3>Configurações</h3>
                <div class="form-grid" style="margin-bottom: 40px;">
                    <input type="text" id="conf-sitename" placeholder="Nome do Site">
                    <button class="btn btn-sec" onclick="window.saveSettings()">Salvar Configs</button>
                </div>

                <h3>Lista de Aulas</h3>
                <div id="admin-ep-list"></div>
            </div>
        </div>
    </div>

    <!-- PLAYER OVERLAY -->
    <div id="player-overlay" class="hidden">
        <div class="player-header">
            <div class="logo">AULA EM ANDAMENTO</div>
            <button class="btn btn-sec" onclick="window.closePlayer()">FECHAR X</button>
        </div>

        <!-- VÍDEO (API YOUTUBE) -->
        <div id="video-stage">
            <div id="yt-player-placeholder"></div>
        </div>

        <!-- TEXTO (LEITURA) -->
        <div id="text-stage" class="hidden">
            <h2 id="text-title" style="color: var(--primary);">Resumo</h2>
            <div id="text-content"></div>
            
            <div class="reading-controls">
                <div id="status-reading" style="color: var(--primary); font-weight: bold;">
                    <i class="fas fa-volume-up"></i> Lendo Automaticamente...
                </div>
                
                <div class="speed-control">
                    <label>Velocidade:</label>
                    <input type="range" id="tts-speed" min="0.5" max="2.0" step="0.25" value="1.0">
                    <span id="speed-val">1.0x</span>
                </div>

                <button class="btn btn-sec" onclick="window.forceNextEpisode()">
                    Próximo Manual >>
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Script da API do YouTube (Carregado Dinamicamente) -->
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } 
            from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, setDoc, onSnapshot, query, orderBy, serverTimestamp } 
            from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCRnLXwHj_jAuZZcICdwGnqgqtBnvNIsMQ",
            authDomain: "studyflixpro.firebaseapp.com",
            projectId: "studyflixpro",
            storageBucket: "studyflixpro.firebasestorage.app",
            messagingSenderId: "658926227849",
            appId: "1:658926227849:web:1805d4ebbaf14046c85158"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ESTADO GLOBAL
        let currentUser = null;
        let quillEditor;
        let allEpisodes = [];
        let watchedEpisodes = {}; // { 'idAula': true }
        
        // Player
        let ytPlayer = null;
        let currentSeriesEpisodes = [];
        let currentEpisodeIndex = -1;
        
        // TTS
        let speechSynth = window.speechSynthesis;
        let speechUtterance = null;

        // --- INICIALIZAÇÃO ---
        
        // Carregar API YouTube
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // Inicializar Editor
        window.addEventListener('DOMContentLoaded', () => {
            quillEditor = new Quill('#editor-container', {
                theme: 'snow',
                modules: { toolbar: [['bold', 'italic', 'underline'], [{'header':1},{'header':2}], [{'list':'ordered'},{'list':'bullet'}], ['clean']] }
            });
        });

        // Autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                // Admin Check
                if (user.email.includes('@userpro')) {
                    document.getElementById('admin-btn').classList.remove('hidden');
                }

                loadSettings();
                loadUserData(); // Carrega histórico
                loadEpisodes(); // Carrega aulas
            } else {
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        // --- CARREGAMENTO DE DADOS ---

        // 1. Histórico do Usuário (Watched)
        function loadUserData() {
            if(!currentUser) return;
            // Ouve em tempo real a coleção de histórico do usuário
            const historyRef = collection(db, "users", currentUser.uid, "history");
            onSnapshot(historyRef, (snapshot) => {
                watchedEpisodes = {};
                snapshot.forEach(doc => {
                    watchedEpisodes[doc.id] = true;
                });
                renderHome(); // Re-renderiza para mostrar barras de progresso
            });
        }

        // 2. Episódios
        function loadEpisodes() {
            const q = query(collection(db, "episodes"));
            onSnapshot(q, (snapshot) => {
                allEpisodes = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    d.id = doc.id;
                    d.series = d.series || "Geral";
                    d.season = parseInt(d.season) || 1;
                    d.episodeNumber = parseInt(d.episodeNumber) || 1;
                    allEpisodes.push(d);
                });
                renderHome();
            });
        }

        function renderHome() {
            if(allEpisodes.length === 0) return;

            // Agrupar por Série
            const seriesMap = {};
            allEpisodes.forEach(ep => {
                if (!seriesMap[ep.series]) seriesMap[ep.series] = [];
                seriesMap[ep.series].push(ep);
            });

            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            
            Object.keys(seriesMap).sort().forEach(series => {
                let eps = seriesMap[series];
                // Ordenar: Temp > Ep
                eps.sort((a,b) => (a.season - b.season) || (a.episodeNumber - b.episodeNumber));

                let html = `
                    <div class="category-row">
                        <div class="category-title">${series}</div>
                        <div class="row-scroller">
                `;

                eps.forEach(ep => {
                    const thumb = getYoutubeThumb(ep.videoUrl);
                    // Checar se já foi assistido
                    const isWatched = watchedEpisodes[ep.id] ? 'watched' : '';
                    
                    html += `
                        <div class="episode-card ${isWatched}" onclick="window.startPlayer('${ep.id}')">
                            <img src="${thumb}" onerror="this.src='https://via.placeholder.com/260x146?text=Aula'">
                            <div class="progress-bar-container"><div class="progress-bar-fill"></div></div>
                            <div class="episode-info">
                                <span style="background:var(--primary); padding:2px 5px; border-radius:2px; font-weight:bold;">T${ep.season}:E${ep.episodeNumber}</span>
                                <span>${ep.title}</span>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            });
        }

        // --- PLAYER AUTOMÁTICO (CORE) ---

        window.startPlayer = (id) => {
            const ep = allEpisodes.find(e => e.id === id);
            if (!ep) return;

            // Preparar playlist da série atual
            currentSeriesEpisodes = allEpisodes
                .filter(e => e.series === ep.series)
                .sort((a,b) => (a.season - b.season) || (a.episodeNumber - b.episodeNumber));
            currentEpisodeIndex = currentSeriesEpisodes.findIndex(e => e.id === id);

            // UI Switch
            document.getElementById('navbar').classList.add('hidden');
            document.getElementById('player-overlay').classList.remove('hidden');
            document.getElementById('video-stage').classList.remove('hidden');
            document.getElementById('text-stage').classList.add('hidden');

            // Setup Texto (Já deixa pronto)
            document.getElementById('text-title').innerText = ep.title;
            document.getElementById('text-content').innerHTML = ep.contentHtml;

            // INICIAR YOUTUBE PLAYER
            const videoId = extractVideoID(ep.videoUrl);
            
            if (ytPlayer) {
                ytPlayer.loadVideoById(videoId);
            } else {
                ytPlayer = new YT.Player('yt-player-placeholder', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
            }
        };

        // EVENTO: VÍDEO MUDOU DE ESTADO
        function onPlayerStateChange(event) {
            // YT.PlayerState.ENDED = 0
            if (event.data === 0) {
                console.log("Vídeo acabou! Iniciando texto...");
                finishVideoAndStartText();
            }
        }

        function finishVideoAndStartText() {
            // Esconder vídeo (não destruir, apenas ocultar para manter instância se quiser)
            // Mas para parar áudio garantido, pause.
            if(ytPlayer) ytPlayer.stopVideo();
            
            document.getElementById('video-stage').classList.add('hidden');
            document.getElementById('text-stage').classList.remove('hidden');
            
            // Iniciar Leitura Automática (TTS)
            setTimeout(() => {
                speakText();
            }, 1000);
        }

        // TTS (Leitura)
        function speakText() {
            if(speechSynth.speaking) speechSynth.cancel();

            const text = document.getElementById('text-content').innerText;
            speechUtterance = new SpeechSynthesisUtterance(text);
            speechUtterance.lang = 'pt-BR';
            speechUtterance.rate = parseFloat(document.getElementById('tts-speed').value);

            // EVENTO: TEXTO ACABOU DE SER LIDO
            speechUtterance.onend = () => {
                console.log("Texto finalizado. Salvando progresso e avançando...");
                completeEpisodeAndNext();
            };

            speechSynth.speak(speechUtterance);
        }

        // CONCLUSÃO E PRÓXIMO
        async function completeEpisodeAndNext() {
            // 1. Salvar no Firestore que viu este episódio
            const currentEp = currentSeriesEpisodes[currentEpisodeIndex];
            if(currentEp && currentUser) {
                try {
                    await setDoc(doc(db, "users", currentUser.uid, "history", currentEp.id), {
                        completedAt: serverTimestamp(),
                        series: currentEp.series
                    });
                    console.log("Progresso salvo.");
                } catch(e) { console.error("Erro ao salvar progresso:", e); }
            }

            // 2. Ir para o próximo
            window.forceNextEpisode();
        }

        window.forceNextEpisode = () => {
            if(speechSynth) speechSynth.cancel();

            const nextIndex = currentEpisodeIndex + 1;
            if (nextIndex < currentSeriesEpisodes.length) {
                const nextEp = currentSeriesEpisodes[nextIndex];
                // Pequeno delay para transição visual
                setTimeout(() => {
                    window.startPlayer(nextEp.id);
                }, 1000);
            } else {
                alert("Parabéns! Você concluiu esta matéria.");
                window.closePlayer();
            }
        };

        window.closePlayer = () => {
            if(ytPlayer) ytPlayer.stopVideo();
            if(speechSynth) speechSynth.cancel();
            document.getElementById('iframe-wrapper').innerHTML = ''; // Limpar para garantir
            window.router('home');
        };

        // --- ADMIN: CRUD COMPLETO ---

        // Variável para saber se estamos editando
        let editingId = null;

        window.saveEpisode = async () => {
            const data = {
                series: document.getElementById('ep-series').value,
                season: parseInt(document.getElementById('ep-season').value),
                episodeNumber: parseInt(document.getElementById('ep-number').value),
                title: document.getElementById('ep-title').value,
                videoUrl: document.getElementById('ep-video').value,
                contentHtml: quillEditor.root.innerHTML
            };

            if (!data.title || !data.videoUrl) return alert("Título e Vídeo obrigatórios.");

            try {
                if (editingId) {
                    // UPDATE
                    await updateDoc(doc(db, "episodes", editingId), data);
                    alert("Aula atualizada!");
                    window.resetForm();
                } else {
                    // CREATE
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, "episodes"), data);
                    alert("Aula criada!");
                    // Auto-incremento para facilitar
                    document.getElementById('ep-number').value = data.episodeNumber + 1;
                    document.getElementById('ep-title').value = '';
                    quillEditor.setText('');
                }
            } catch(e) { alert("Erro: " + e.message); }
        };

        // Carregar lista Admin com Edit/Delete
        window.loadAdminList = async () => {
            const listDiv = document.getElementById('admin-ep-list');
            listDiv.innerHTML = 'Carregando...';
            
            const q = query(collection(db, "episodes"));
            const snapshot = await getDocs(q);
            const items = [];
            snapshot.forEach(doc => { items.push({ ...doc.data(), id: doc.id }); });

            // Ordenar
            items.sort((a,b) => a.series.localeCompare(b.series) || (a.season - b.season) || (a.episodeNumber - b.episodeNumber));

            listDiv.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'admin-list-item';
                div.innerHTML = `
                    <div>
                        <strong>${item.series}</strong> <br>
                        <small>T${item.season}:E${item.episodeNumber} - ${item.title}</small>
                    </div>
                    <div class="admin-actions">
                        <button class="btn btn-warning" onclick="window.editEp('${item.id}')"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn btn-primary" style="background:red;" onclick="window.deleteEp('${item.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        };

        // Função EDITAR
        window.editEp = async (id) => {
            const ep = allEpisodes.find(e => e.id === id);
            if(!ep) return;

            editingId = id;
            document.getElementById('form-title').innerText = "Editando Aula: " + ep.title;
            document.getElementById('btn-save').innerText = "Atualizar Aula";
            document.getElementById('btn-cancel').classList.remove('hidden');

            document.getElementById('ep-series').value = ep.series;
            document.getElementById('ep-season').value = ep.season;
            document.getElementById('ep-number').value = ep.episodeNumber;
            document.getElementById('ep-title').value = ep.title;
            document.getElementById('ep-video').value = ep.videoUrl;
            quillEditor.root.innerHTML = ep.contentHtml;

            // Rola para o formulário
            document.getElementById('admin-panel').scrollIntoView();
        };

        // Função CANCELAR EDIÇÃO
        window.resetForm = () => {
            editingId = null;
            document.getElementById('form-title').innerText = "Nova Aula";
            document.getElementById('btn-save').innerText = "Publicar Aula";
            document.getElementById('btn-cancel').classList.add('hidden');
            
            // Limpar
            document.getElementById('ep-title').value = '';
            document.getElementById('ep-video').value = '';
            quillEditor.setText('');
        };

        // Função DELETE
        window.deleteEp = async (id) => {
            if(confirm("Tem certeza que deseja apagar?")) {
                await deleteDoc(doc(db, "episodes", id));
                window.loadAdminList();
            }
        };

        // --- HELPERS ---
        function extractVideoID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function getYoutubeThumb(url) {
            const id = extractVideoID(url);
            return id ? `https://img.youtube.com/vi/${id}/mqdefault.jpg` : '';
        }

        function loadSettings() {
             const docRef = doc(db, "settings", "global");
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.title = data.siteName || "StudyFlix";
                    document.getElementById('site-logo-text').innerText = data.siteName || "STUDYFLIX";
                }
            });
        }

        // --- SISTEMA BASICO ---
        window.saveSettings = async () => {
             const name = document.getElementById('conf-sitename').value;
             await setDoc(doc(db, "settings", "global"), { siteName: name });
             alert("Salvo!");
        };
        
        window.createTempUser = async () => {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pass').value;
            if(e && p) createUserWithEmailAndPassword(auth, e, p).then(()=>alert("Criado!")).catch(err=>alert(err));
        };
        window.doLogout = () => auth.signOut();
        
        window.router = (r) => {
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            if(r === 'home') document.getElementById('home-view').classList.remove('hidden');
            if(r === 'admin') {
                if(!currentUser.email.includes('@userpro')) return alert("Acesso Negado");
                document.getElementById('admin-view').classList.remove('hidden');
                window.loadAdminList();
            }
        };

        // Event listener velocidade TTS
        document.getElementById('tts-speed').addEventListener('input', (e) => {
             document.getElementById('speed-val').innerText = e.target.value + 'x';
             if(speechSynth.speaking) speakText(); // Reinicia com nova vel
        });

    </script>
</body>
</html>
