<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando StudyFlix...</title>
    <link id="dynamic-favicon" rel="icon" type="image/png" href="https://assets.nflxext.com/us/ffe/siteui/common/icons/nficon2016.png">
    
    <!-- Bibliotecas Externas (CDNs) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Quill Editor (Rich Text) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- YouTube Iframe API (Para detecção de fim de vídeo) -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        netflix: {
                            red: '#E50914',
                            redHover: '#b20710',
                            dark: '#141414',
                            black: '#000000',
                            gray: '#2F2F2F',
                            lightGray: '#e5e5e5'
                        }
                    },
                    fontFamily: {
                        sans: ['Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Personalizado para Experiência Imersiva */
        body {
            background-color: #141414;
            color: #fff;
            overflow-x: hidden;
        }

        /* Scrollbar Netflix Style */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background: #404040; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #E50914; }

        /* Classes Utilitárias */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ajustes do Editor Quill no tema escuro */
        .ql-toolbar { background: #e5e5e5; border-radius: 4px 4px 0 0; }
        .ql-container { background: #fff; color: #000; border-radius: 0 0 4px 4px; min-height: 200px; }
        
        /* Layout do Player Split Screen */
        .split-player {
            display: grid;
            grid-template-columns: 1fr;
            height: calc(100vh - 64px); /* Altura total menos navbar */
        }
        @media (min-width: 1024px) {
            .split-player {
                grid-template-columns: 1.5fr 1fr; /* Video maior que slide */
            }
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #E50914;
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- App Root -->
    <div id="app" class="min-h-screen relative">
        <div id="loading-overlay" class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <h1 class="text-3xl font-bold text-netflix-red tracking-widest uppercase">Carregando Ambiente de Estudos...</h1>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-[9999] flex flex-col gap-3"></div>

    <!-- Módulo Principal JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, setDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- 1. CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyC38VXjnYskoAx5SLF6n3PiEgnaRtz4IJ0",
            authDomain: "studyflix53.firebaseapp.com",
            projectId: "studyflix53",
            storageBucket: "studyflix53.firebasestorage.app",
            messagingSenderId: "799853597162",
            appId: "1:799853597162:web:179f1450c419157d62a293"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. STORE GLOBAL (Gestão de Estado) ---
        const Store = {
            user: null,
            isAdmin: false,
            settings: { title: 'StudyFlix', favicon: '' },
            series: [],
            seasons: [],
            episodes: [],
            progress: {}, // { episodeId: { completed: bool, timestamp: ... } }
            
            // Player State
            currentEpisode: null,
            currentSeries: null,
            nextEpisode: null,
            
            // Navegação
            currentView: 'loading',
            params: {},

            listeners: [],
            subscribe(fn) { this.listeners.push(fn); },
            notify() { this.listeners.forEach(fn => fn(this)); }
        };

        // --- 3. SERVIÇOS E UTILITÁRIOS ---

        const Utils = {
            // Extrai ID do YouTube de URLs variadas
            getYoutubeId(url) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            },
            
            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const div = document.createElement('div');
                div.className = `px-6 py-4 rounded shadow-lg text-white font-bold flex items-center gap-3 transform transition-all duration-500 translate-x-full ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
                div.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check' : 'fa-info-circle'}"></i> ${msg}`;
                container.appendChild(div);
                
                requestAnimationFrame(() => div.classList.remove('translate-x-full'));
                setTimeout(() => {
                    div.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => div.remove(), 500);
                }, 4000);
            },

            // TTS (Text to Speech)
            speak(text, rate = 1) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel(); // Para anterior
                    const utterance = new SpeechSynthesisUtterance(text.replace(/<[^>]*>/g, '')); // Remove HTML tags
                    utterance.lang = 'pt-BR';
                    utterance.rate = rate;
                    window.speechSynthesis.speak(utterance);
                } else {
                    this.showToast("Seu navegador não suporta leitura de texto.", "error");
                }
            },
            
            stopSpeech() {
                if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            }
        };

        const DataService = {
            async initApp() {
                await this.fetchSettings();
                // Auth listener dispara o resto
            },

            async fetchSettings() {
                try {
                    const snap = await getDoc(doc(db, "settings", "global"));
                    if (snap.exists()) {
                        Store.settings = snap.data();
                        document.title = Store.settings.title || "StudyFlix";
                        if (Store.settings.favicon) document.getElementById('dynamic-favicon').href = Store.settings.favicon;
                    }
                } catch(e) { console.log("Configurações padrão usadas."); }
            },

            async fetchContent() {
                try {
                    // Buscar Séries (Matérias)
                    const seriesQ = query(collection(db, "series"), orderBy("title"));
                    const seriesSnap = await getDocs(seriesQ);
                    Store.series = seriesSnap.docs.map(d => ({id: d.id, ...d.data()}));

                    // Buscar Temporadas (Unidades)
                    const seasonsQ = query(collection(db, "seasons"), orderBy("order", "asc"));
                    const seasonsSnap = await getDocs(seasonsQ);
                    Store.seasons = seasonsSnap.docs.map(d => ({id: d.id, ...d.data()}));

                    // Buscar Episódios (Aulas)
                    const epQ = query(collection(db, "episodes"), orderBy("order", "asc"));
                    const epSnap = await getDocs(epQ);
                    Store.episodes = epSnap.docs.map(d => ({id: d.id, ...d.data()}));

                    // Buscar Progresso do Usuário
                    if(Store.user) {
                        const userSnap = await getDoc(doc(db, "users", Store.user.uid));
                        if(userSnap.exists()) {
                            Store.progress = userSnap.data().progress || {};
                        }
                    }

                    Store.notify();
                } catch (error) {
                    console.error("Erro ao buscar dados:", error);
                    Utils.showToast("Erro ao carregar conteúdo.", "error");
                }
            },

            async saveProgress(episodeId) {
                if(!Store.user) return;
                const newProgress = { ...Store.progress, [episodeId]: { completed: true, timestamp: Date.now() }};
                Store.progress = newProgress;
                await updateDoc(doc(db, "users", Store.user.uid), { progress: newProgress });
                Store.notify();
            },

            // --- CRUD ADMIN ---
            async createItem(collectionName, data) {
                await addDoc(collection(db, collectionName), data);
                await this.fetchContent();
                Utils.showToast("Item criado com sucesso!", "success");
            },
            async updateItem(collectionName, id, data) {
                await updateDoc(doc(db, collectionName, id), data);
                await this.fetchContent();
                Utils.showToast("Item atualizado com sucesso!", "success");
            },
            async deleteItem(collectionName, id) {
                if(confirm("Tem certeza? Essa ação é irreversível.")) {
                    await deleteDoc(doc(db, collectionName, id));
                    await this.fetchContent();
                    Utils.showToast("Item excluído.", "success");
                }
            },
            async saveSettings(data) {
                await setDoc(doc(db, "settings", "global"), data);
                await this.fetchSettings();
                Utils.showToast("Configurações salvas!", "success");
            }
        };

        const AuthService = {
            init() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        Store.user = user;
                        // Verifica se é admin (Domínio secreto)
                        Store.isAdmin = user.email.endsWith("@userpro.com");
                        
                        await DataService.fetchContent();
                        if (Store.currentView === 'login' || Store.currentView === 'loading') {
                            Router.navigate('browse');
                        }
                    } else {
                        Store.user = null;
                        Store.isAdmin = false;
                        Router.navigate('login');
                    }
                    // Remove loader
                    const loader = document.getElementById('loading-overlay');
                    if(loader) loader.classList.add('hidden');
                });
            },
            async login(email, password) {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (e) { Utils.showToast("Erro de login: " + e.message, "error"); }
            },
            async register(email, password) {
                try {
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", cred.user.uid), { 
                        email: email, 
                        createdAt: serverTimestamp(),
                        progress: {}
                    });
                    Utils.showToast("Conta criada!", "success");
                } catch (e) { Utils.showToast("Erro no registro: " + e.message, "error"); }
            },
            async logout() {
                await signOut(auth);
                Utils.showToast("Você saiu.", "info");
            }
        };

        // --- 4. ROTEAMENTO E COMPONENTES DE UI ---

        const Router = {
            navigate(view, params = {}) {
                Utils.stopSpeech(); // Parar TTS ao mudar de página
                Store.currentView = view;
                Store.params = params;
                this.render();
            },
            render() {
                const app = document.getElementById('app');
                // Limpa conteúdo
                app.innerHTML = ''; 
                
                // Rotas
                switch(Store.currentView) {
                    case 'login': app.innerHTML = Components.LoginPage(); break;
                    case 'browse': app.innerHTML = Components.BrowsePage(); break;
                    case 'series-detail': app.innerHTML = Components.SeriesDetailPage(Store.params.id); break;
                    case 'watch': app.innerHTML = Components.PlayerPage(Store.params.id); break;
                    case 'admin': 
                        if(Store.isAdmin) app.innerHTML = Components.AdminPage(); 
                        else this.navigate('browse');
                        break;
                    default: app.innerHTML = Components.BrowsePage();
                }

                this.attachGlobalEvents();
                this.runPageScripts();
            },
            attachGlobalEvents() {
                // Logout, Nav buttons...
                const logoutBtn = document.getElementById('btn-logout');
                if(logoutBtn) logoutBtn.onclick = () => AuthService.logout();
            },
            runPageScripts() {
                if(Store.currentView === 'login') Scripts.login();
                if(Store.currentView === 'admin') Scripts.admin();
                if(Store.currentView === 'watch') Scripts.player(Store.params.id);
            }
        };

        const Components = {
            Navbar() {
                return `
                <nav class="fixed top-0 w-full z-40 bg-gradient-to-b from-black/90 to-transparent px-8 py-4 flex justify-between items-center transition-all duration-300 hover:bg-black" id="navbar">
                    <div class="flex items-center gap-8">
                        <div class="text-netflix-red font-bold text-3xl tracking-tighter cursor-pointer" onclick="window.router.navigate('browse')">
                            ${Store.settings.title.toUpperCase()}
                        </div>
                        <ul class="flex gap-4 text-sm font-medium text-gray-300">
                            <li class="hover:text-white cursor-pointer transition" onclick="window.router.navigate('browse')">Início</li>
                            <li class="hover:text-white cursor-pointer transition">Minhas Aulas</li>
                            ${Store.isAdmin ? `<li class="text-yellow-500 hover:text-yellow-400 cursor-pointer font-bold" onclick="window.router.navigate('admin')">ADMIN CMS</li>` : ''}
                        </ul>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right hidden md:block">
                            <p class="text-xs text-gray-400">Logado como</p>
                            <p class="text-sm font-bold text-white">${Store.user?.email}</p>
                        </div>
                        <button id="btn-logout" class="bg-netflix-red px-4 py-1 rounded hover:bg-netflix-redHover text-sm font-bold">Sair</button>
                    </div>
                </nav>
                `;
            },

            LoginPage() {
                return `
                <div class="min-h-screen flex items-center justify-center bg-[url('https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bcae-07a3f8dc141a/f6d7434e-d6de-4185-a6d4-c77a2d08737b/US-en-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg')] bg-cover bg-center">
                    <div class="absolute inset-0 bg-black/70"></div>
                    <div class="relative z-10 bg-black/80 p-12 rounded-lg w-full max-w-md">
                        <h2 class="text-3xl font-bold mb-8 text-white">Entrar</h2>
                        <form id="auth-form" class="flex flex-col gap-4">
                            <input type="email" id="email" placeholder="Email (@userpro.com para admin)" class="bg-gray-700 p-3 rounded text-white border-none focus:ring-2 focus:ring-netflix-red" required>
                            <input type="password" id="password" placeholder="Senha" class="bg-gray-700 p-3 rounded text-white border-none focus:ring-2 focus:ring-netflix-red" required>
                            <button type="submit" class="bg-netflix-red text-white font-bold py-3 rounded mt-4 hover:bg-netflix-redHover transition">Acessar Plataforma</button>
                        </form>
                        <p class="text-gray-400 mt-4 text-sm">
                            Novo por aqui? <span class="text-white font-bold cursor-pointer hover:underline" id="toggle-auth">Cadastre-se agora.</span>
                        </p>
                    </div>
                </div>
                `;
            },

            BrowsePage() {
                // Agrupar cursos por Categoria
                const categories = [...new Set(Store.series.map(s => s.category || 'Geral'))];

                return `
                ${this.Navbar()}
                <div class="pt-24 px-8 pb-10">
                    <h1 class="text-4xl font-bold mb-2">Painel de Estudos</h1>
                    <p class="text-gray-400 mb-8">Organizado para Ciência da Computação (Anhanguera)</p>
                    
                    ${categories.map(cat => `
                        <div class="mb-10 fade-in">
                            <h3 class="text-xl font-bold mb-4 text-gray-200 border-l-4 border-netflix-red pl-3">${cat}</h3>
                            <div class="flex gap-4 overflow-x-auto hide-scroll pb-4">
                                ${Store.series.filter(s => s.category === cat).map(s => `
                                    <div class="flex-none w-64 aspect-video bg-zinc-800 rounded relative cursor-pointer hover:scale-105 transition-transform duration-300 group" 
                                         onclick="window.router.navigate('series-detail', {id: '${s.id}'})">
                                        <img src="${s.thumbnail}" class="w-full h-full object-cover rounded opacity-80 group-hover:opacity-100">
                                        <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-100"></div>
                                        <div class="absolute bottom-3 left-3">
                                            <p class="font-bold text-white drop-shadow-md">${s.title}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}

                    ${Store.series.length === 0 ? '<div class="text-center text-gray-500 mt-20">Nenhum conteúdo cadastrado ainda. Acesse o Admin.</div>' : ''}
                </div>
                `;
            },

            SeriesDetailPage(seriesId) {
                const serie = Store.series.find(s => s.id === seriesId);
                if (!serie) return this.BrowsePage();

                // Filtrar temporadas dessa série e ordenar
                const seasons = Store.seasons.filter(s => s.seriesId === seriesId).sort((a,b) => a.order - b.order);

                return `
                ${this.Navbar()}
                <div class="relative h-[60vh] w-full">
                    <img src="${serie.thumbnail}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-netflix-dark via-netflix-dark/60 to-transparent"></div>
                    <div class="absolute bottom-10 left-8 max-w-2xl fade-in">
                        <h1 class="text-5xl font-bold mb-4">${serie.title}</h1>
                        <p class="text-lg text-gray-300 mb-6 drop-shadow-md">${serie.description || 'Sem descrição.'}</p>
                        <button onclick="window.history.back()" class="bg-gray-600/80 hover:bg-gray-600 text-white px-6 py-2 rounded font-bold flex items-center gap-2">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                </div>

                <div class="px-8 pb-20 -mt-20 relative z-10">
                    ${seasons.map(season => {
                        const episodes = Store.episodes
                            .filter(e => e.seasonId === season.id)
                            .sort((a,b) => a.order - b.order);

                        return `
                        <div class="mb-8 bg-zinc-900/50 p-6 rounded-lg border border-zinc-800 backdrop-blur-sm">
                            <h2 class="text-2xl font-bold mb-4 text-netflix-red">${season.title} <span class="text-sm text-gray-500 font-normal ml-2">(Unidade ${season.order})</span></h2>
                            
                            <div class="flex flex-col gap-2">
                                ${episodes.map(ep => {
                                    const isCompleted = Store.progress[ep.id]?.completed;
                                    return `
                                    <div class="flex items-center justify-between p-4 bg-zinc-800 hover:bg-zinc-700 rounded transition cursor-pointer border-l-4 ${isCompleted ? 'border-green-500' : 'border-gray-600'}"
                                         onclick="window.router.navigate('watch', {id: '${ep.id}'})">
                                        <div class="flex items-center gap-4">
                                            <div class="w-8 h-8 rounded-full bg-zinc-900 flex items-center justify-center font-bold text-gray-400">
                                                ${ep.order}
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-white ${isCompleted ? 'text-gray-400 line-through' : ''}">${ep.title}</h4>
                                                <p class="text-xs text-gray-400">Aula ${ep.order}</p>
                                            </div>
                                        </div>
                                        <div class="text-2xl text-white opacity-0 hover:opacity-100 transition-opacity">
                                            <i class="fas fa-play-circle"></i>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                                ${episodes.length === 0 ? '<p class="text-gray-500 italic">Nenhuma aula cadastrada nesta unidade.</p>' : ''}
                            </div>
                        </div>
                        `;
                    }).join('')}
                    ${seasons.length === 0 ? '<div class="text-center p-10 bg-zinc-900 rounded">Nenhuma Unidade (Temporada) encontrada.</div>' : ''}
                </div>
                `;
            },

            PlayerPage(episodeId) {
                const ep = Store.episodes.find(e => e.id === episodeId);
                if (!ep) return `<div class="p-10">Aula não encontrada. <button onclick="window.history.back()">Voltar</button></div>`;

                // Encontrar próxima aula para lógica automática
                const currentSeasonEps = Store.episodes.filter(e => e.seasonId === ep.seasonId).sort((a,b) => a.order - b.order);
                const currentIndex = currentSeasonEps.findIndex(e => e.id === ep.id);
                Store.nextEpisode = currentSeasonEps[currentIndex + 1] || null;

                // Processar slides
                const slides = ep.slideUrl ? ep.slideUrl.split('\n').filter(s => s.trim() !== '') : [];

                return `
                <div class="h-screen flex flex-col bg-black">
                    <!-- Header Minimalista -->
                    <div class="h-16 flex items-center justify-between px-4 border-b border-zinc-800 bg-zinc-900 z-50">
                        <div class="flex items-center gap-4">
                            <button onclick="window.history.back()" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left fa-lg"></i></button>
                            <h2 class="font-bold truncate max-w-md">${ep.title}</h2>
                        </div>
                        <div class="flex items-center gap-2">
                             <span id="auto-timer" class="text-netflix-red font-bold animate-pulse hidden">Próxima em 5s...</span>
                             <button onclick="window.finishLesson()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded text-sm font-bold">
                                <i class="fas fa-check"></i> Concluir Aula
                             </button>
                        </div>
                    </div>

                    <!-- Corpo Principal -->
                    <div class="flex-1 split-player relative overflow-hidden">
                        
                        <!-- Coluna Esquerda: Vídeo / Leitura -->
                        <div class="relative bg-black flex flex-col border-r border-zinc-800">
                            
                            <!-- Modo VIDEO -->
                            <div id="video-container" class="absolute inset-0 z-20 bg-black flex items-center justify-center">
                                <div id="yt-player"></div>
                            </div>

                            <!-- Modo LEITURA (Fica atrás do vídeo até ele acabar ou ser fechado) -->
                            <div id="reading-container" class="absolute inset-0 z-10 bg-zinc-900 overflow-y-auto p-8 opacity-0 pointer-events-none transition-opacity duration-500">
                                <div class="max-w-3xl mx-auto">
                                    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                                        <h3 class="text-2xl font-bold text-netflix-red"><i class="fas fa-book-reader mr-2"></i>Material de Leitura</h3>
                                        <div class="flex gap-2 bg-zinc-800 rounded p-1">
                                            <button onclick="window.toggleSpeech()" id="btn-speech" class="p-2 hover:text-white text-gray-400" title="Ler em voz alta"><i class="fas fa-volume-up"></i></button>
                                            <button onclick="window.changeSpeed(0.8)" class="text-xs text-gray-400 hover:text-white px-2">0.8x</button>
                                            <button onclick="window.changeSpeed(1.2)" class="text-xs text-gray-400 hover:text-white px-2">1.2x</button>
                                        </div>
                                    </div>
                                    <div id="content-text" class="prose prose-invert prose-lg text-gray-300">
                                        ${ep.textContent || '<p>Sem material de leitura para esta aula.</p>'}
                                    </div>
                                    <div class="h-20"></div> <!-- Espaço final -->
                                </div>
                            </div>
                        </div>

                        <!-- Coluna Direita: Slides Manuais -->
                        <div class="bg-zinc-900 flex flex-col relative h-full border-l border-zinc-800">
                            <div class="bg-zinc-800 p-2 text-center text-xs font-bold uppercase tracking-wider text-gray-400">Slides da Aula</div>
                            
                            <div class="flex-1 relative flex items-center justify-center bg-black overflow-hidden">
                                ${slides.length > 0 ? `
                                    <img id="current-slide" src="${slides[0]}" class="max-w-full max-h-full object-contain transition-all duration-300">
                                ` : '<div class="text-gray-600">Sem slides disponíveis</div>'}
                            </div>

                            ${slides.length > 0 ? `
                                <div class="h-14 bg-zinc-800 flex justify-between items-center px-4">
                                    <button onclick="window.changeSlide(-1)" class="text-white hover:text-netflix-red"><i class="fas fa-chevron-left fa-lg"></i></button>
                                    <span class="text-sm font-mono text-gray-300"><span id="slide-index">1</span> / ${slides.length}</span>
                                    <button onclick="window.changeSlide(1)" class="text-white hover:text-netflix-red"><i class="fas fa-chevron-right fa-lg"></i></button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            },

            AdminPage() {
                // Estrutura simples de abas
                return `
                ${this.Navbar()}
                <div class="pt-24 px-8 pb-20">
                    <h1 class="text-3xl font-bold mb-6 text-yellow-500">CMS Administrativo (@userpro)</h1>
                    
                    <!-- Tabs -->
                    <div class="flex gap-4 mb-8 border-b border-zinc-700 pb-2">
                        <button class="px-4 py-2 text-white font-bold bg-zinc-800 rounded hover:bg-zinc-700" onclick="window.showTab('config')">Config Global</button>
                        <button class="px-4 py-2 text-white font-bold bg-zinc-800 rounded hover:bg-zinc-700" onclick="window.showTab('series')">Séries (Matérias)</button>
                        <button class="px-4 py-2 text-white font-bold bg-zinc-800 rounded hover:bg-zinc-700" onclick="window.showTab('seasons')">Temporadas (Unidades)</button>
                        <button class="px-4 py-2 text-white font-bold bg-zinc-800 rounded hover:bg-zinc-700" onclick="window.showTab('episodes')">Episódios (Aulas)</button>
                    </div>

                    <!-- Conteúdo das Tabs (Gerado via JS para simplificar o HTML) -->
                    <div id="admin-content" class="bg-zinc-900 p-6 rounded border border-zinc-800 min-h-[500px]">
                        <p class="text-gray-400">Selecione uma categoria acima para gerenciar.</p>
                    </div>
                </div>
                
                <!-- Templates de Formulários Ocultos -->
                <div id="forms-container"></div>
                `;
            }
        };

        const Scripts = {
            login() {
                const btn = document.getElementById('toggle-auth');
                const form = document.getElementById('auth-form');
                let isLogin = true;

                btn.onclick = () => {
                    isLogin = !isLogin;
                    document.querySelector('h2').innerText = isLogin ? 'Entrar' : 'Cadastrar';
                    form.querySelector('button').innerText = isLogin ? 'Acessar Plataforma' : 'Criar Conta';
                    btn.innerText = isLogin ? 'Cadastre-se agora.' : 'Já tenho conta.';
                };

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('email').value;
                    const pass = document.getElementById('password').value;
                    if(isLogin) await AuthService.login(email, pass);
                    else await AuthService.register(email, pass);
                };
            },

            player(episodeId) {
                const ep = Store.episodes.find(e => e.id === episodeId);
                const slides = ep.slideUrl ? ep.slideUrl.split('\n').filter(s => s.trim()) : [];
                let currentSlide = 0;
                let readingMode = false;

                // Slide Logic
                window.changeSlide = (dir) => {
                    if(slides.length === 0) return;
                    currentSlide += dir;
                    if(currentSlide < 0) currentSlide = 0;
                    if(currentSlide >= slides.length) currentSlide = slides.length - 1;
                    document.getElementById('current-slide').src = slides[currentSlide];
                    document.getElementById('slide-index').innerText = currentSlide + 1;
                };

                // YouTube Logic
                const videoId = Utils.getYoutubeId(ep.videoUrl);
                
                // Variável global para YT API
                window.onYouTubeIframeAPIReady = () => {
                    new YT.Player('yt-player', {
                        height: '100%',
                        width: '100%',
                        videoId: videoId,
                        playerVars: { 'autoplay': 0, 'rel': 0 },
                        events: {
                            'onStateChange': (event) => {
                                // 0 = Ended
                                if (event.data === 0) {
                                    window.switchToReading();
                                }
                            }
                        }
                    });
                };

                // Se API já carregou (spa navigation), chamar manual
                if (window.YT && window.YT.Player) {
                    window.onYouTubeIframeAPIReady();
                }

                // Troca para Leitura
                window.switchToReading = () => {
                    if(readingMode) return;
                    readingMode = true;
                    const vidContainer = document.getElementById('video-container');
                    const readContainer = document.getElementById('reading-container');
                    
                    vidContainer.classList.add('opacity-0', 'pointer-events-none');
                    readContainer.classList.remove('opacity-0', 'pointer-events-none');
                    readContainer.classList.add('opacity-100', 'pointer-events-auto');
                    
                    Utils.showToast("Iniciando Modo Leitura...", "info");
                    
                    // Auto ler após 1s
                    setTimeout(() => {
                        window.toggleSpeech(true);
                    }, 1000);
                };

                // TTS
                let isSpeaking = false;
                let speechRate = 1.0;
                
                window.toggleSpeech = (forceStart = false) => {
                    if(isSpeaking && !forceStart) {
                        Utils.stopSpeech();
                        isSpeaking = false;
                        document.getElementById('btn-speech').innerHTML = '<i class="fas fa-volume-up"></i>';
                    } else {
                        Utils.speak(ep.textContent || "Fim da aula.", speechRate);
                        isSpeaking = true;
                        document.getElementById('btn-speech').innerHTML = '<i class="fas fa-stop text-red-500"></i>';
                    }
                };
                
                window.changeSpeed = (rate) => {
                    speechRate = rate;
                    if(isSpeaking) window.toggleSpeech(true); // Reinicia com nova velocidade
                    Utils.showToast(`Velocidade: ${rate}x`);
                };

                // Finish
                window.finishLesson = async () => {
                    Utils.stopSpeech();
                    await DataService.saveProgress(ep.id);
                    Utils.showToast("Aula Concluída! Próxima em 5s...", "success");
                    
                    const timerEl = document.getElementById('auto-timer');
                    timerEl.classList.remove('hidden');
                    
                    let count = 5;
                    const interval = setInterval(() => {
                        count--;
                        timerEl.innerText = `Próxima em ${count}s...`;
                        if(count <= 0) {
                            clearInterval(interval);
                            if(Store.nextEpisode) {
                                Router.navigate('watch', {id: Store.nextEpisode.id});
                            } else {
                                Utils.showToast("Unidade finalizada!", "success");
                                Router.navigate('series-detail', {id: ep.seriesId});
                            }
                        }
                    }, 1000);
                };
            },

            admin() {
                window.showTab = (tab) => {
                    const container = document.getElementById('admin-content');
                    container.innerHTML = ''; // Limpa

                    if(tab === 'config') {
                        container.innerHTML = `
                            <h3 class="font-bold mb-4">Configurações Gerais</h3>
                            <div class="grid gap-4 max-w-lg">
                                <input type="text" id="site-title" value="${Store.settings.title}" placeholder="Nome do Site" class="p-2 bg-black border border-gray-600 rounded text-white">
                                <input type="text" id="site-favicon" value="${Store.settings.favicon}" placeholder="URL do Favicon" class="p-2 bg-black border border-gray-600 rounded text-white">
                                <button onclick="window.saveGlobalSettings()" class="bg-blue-600 p-2 rounded font-bold hover:bg-blue-700">Salvar Alterações</button>
                            </div>
                        `;
                    }
                    else if(tab === 'series') {
                        this.renderList(container, 'series', Store.series, ['title', 'category'], 
                            [{name: 'title', label: 'Título'}, {name: 'description', label: 'Descrição', type: 'textarea'}, {name: 'thumbnail', label: 'URL Capa'}, {name: 'category', label: 'Categoria'}]);
                    }
                    else if(tab === 'seasons') {
                        this.renderList(container, 'seasons', Store.seasons, ['title', 'seriesId'], 
                            [{name: 'title', label: 'Título da Unidade'}, {name: 'order', label: 'Ordem (Número)', type: 'number'}, {name: 'seriesId', label: 'ID da Série (Matéria)', type: 'select', options: Store.series.map(s => ({val: s.id, txt: s.title}))}]);
                    }
                    else if(tab === 'episodes') {
                         this.renderList(container, 'episodes', Store.episodes, ['title', 'seasonId'], 
                            [
                                {name: 'title', label: 'Título da Aula'}, 
                                {name: 'order', label: 'Ordem', type: 'number'},
                                {name: 'videoUrl', label: 'URL Vídeo (Youtube)'},
                                {name: 'slideUrl', label: 'URLs dos Slides (Um por linha)', type: 'textarea'},
                                {name: 'seriesId', label: 'Série', type: 'select', options: Store.series.map(s => ({val: s.id, txt: s.title}))},
                                {name: 'seasonId', label: 'Unidade', type: 'select', options: Store.seasons.map(s => ({val: s.id, txt: `${s.title} (Série: ${Store.series.find(x=>x.id==s.seriesId)?.title})`}))},
                                {name: 'textContent', label: 'Conteúdo de Leitura', type: 'richtext'}
                            ]);
                    }
                };

                window.saveGlobalSettings = () => {
                    const title = document.getElementById('site-title').value;
                    const fav = document.getElementById('site-favicon').value;
                    DataService.saveSettings({title, favicon: fav});
                };
            },

            // Renderizador Genérico de Lista CRUD
            renderList(container, collectionName, items, displayFields, formFields) {
                // Botão Novo
                const btnNew = document.createElement('button');
                btnNew.className = "mb-4 bg-green-600 px-4 py-2 rounded font-bold hover:bg-green-700";
                btnNew.innerHTML = `<i class="fas fa-plus"></i> Novo Item`;
                btnNew.onclick = () => this.openForm(collectionName, null, formFields);
                container.appendChild(btnNew);

                // Tabela
                const table = document.createElement('table');
                table.className = "w-full text-left border-collapse";
                table.innerHTML = `
                    <thead>
                        <tr class="bg-zinc-800 text-gray-400 border-b border-gray-600">
                            <th class="p-3">ID</th>
                            ${displayFields.map(f => `<th class="p-3 capitalize">${f}</th>`).join('')}
                            <th class="p-3 text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr class="border-b border-zinc-800 hover:bg-zinc-800/50">
                                <td class="p-3 text-xs text-gray-500 font-mono">${item.id.substr(0, 5)}...</td>
                                ${displayFields.map(f => `<td class="p-3 truncate max-w-xs">${item[f] || '-'}</td>`).join('')}
                                <td class="p-3 text-right space-x-2">
                                    <button class="text-blue-400 hover:text-white" onclick='window.editItem("${collectionName}", "${item.id}")'><i class="fas fa-edit"></i></button>
                                    <button class="text-red-500 hover:text-white" onclick='window.deleteItem("${collectionName}", "${item.id}")'><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                container.appendChild(table);

                // Expor funções globais para o HTML string
                window.editItem = (col, id) => {
                    const item = items.find(i => i.id === id);
                    this.openForm(col, item, formFields);
                };
                window.deleteItem = (col, id) => DataService.deleteItem(col, id);
            },

            openForm(collectionName, item, fields) {
                const isNew = !item;
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4";
                
                let formHTML = fields.map(field => {
                    const val = item ? (item[field.name] || '') : '';
                    let input = '';
                    
                    if(field.type === 'textarea') 
                        input = `<textarea id="f-${field.name}" class="w-full bg-zinc-800 p-2 rounded text-white h-24 border border-zinc-600">${val}</textarea>`;
                    else if(field.type === 'select')
                        input = `<select id="f-${field.name}" class="w-full bg-zinc-800 p-2 rounded text-white border border-zinc-600">
                                    ${field.options.map(o => `<option value="${o.val}" ${val === o.val ? 'selected' : ''}>${o.txt}</option>`).join('')}
                                 </select>`;
                    else if(field.type === 'richtext')
                        input = `<div class="bg-white text-black rounded"><div id="editor-container"></div></div><input type="hidden" id="f-${field.name}">`;
                    else 
                        input = `<input type="${field.type || 'text'}" id="f-${field.name}" value="${val}" class="w-full bg-zinc-800 p-2 rounded text-white border border-zinc-600">`;

                    return `<div class="mb-4"><label class="block text-gray-400 text-sm mb-1">${field.label}</label>${input}</div>`;
                }).join('');

                modal.innerHTML = `
                    <div class="bg-zinc-900 w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-lg border border-zinc-700 p-6 relative shadow-2xl">
                        <h2 class="text-2xl font-bold mb-6 text-white">${isNew ? 'Criar' : 'Editar'} Item</h2>
                        <form id="crud-form">
                            ${formHTML}
                            <div class="flex justify-end gap-4 mt-6">
                                <button type="button" class="px-4 py-2 text-gray-400 hover:text-white" onclick="this.closest('.fixed').remove()">Cancelar</button>
                                <button type="submit" class="px-6 py-2 bg-netflix-red hover:bg-netflix-redHover text-white font-bold rounded">Salvar</button>
                            </div>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);

                // Inicializar Quill se necessário
                let quill = null;
                if(fields.find(f => f.type === 'richtext')) {
                    quill = new Quill('#editor-container', {
                        theme: 'snow',
                        modules: { toolbar: [['bold', 'italic', 'underline'], ['link', 'blockquote', 'code-block'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'header': [1, 2, 3, false] }]] }
                    });
                    if(item && item.textContent) quill.root.innerHTML = item.textContent;
                }

                document.getElementById('crud-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const data = {};
                    fields.forEach(f => {
                        if(f.type === 'richtext') data[f.name] = quill.root.innerHTML;
                        else data[f.name] = document.getElementById(`f-${f.name}`).value;
                        
                        // Converter números
                        if(f.type === 'number') data[f.name] = Number(data[f.name]);
                    });

                    if(isNew) await DataService.createItem(collectionName, data);
                    else await DataService.updateItem(collectionName, item.id, data);
                    
                    modal.remove();
                    // Refresh current tab
                    window.showTab(collectionName);
                };
            }
        };

        // --- 5. SETUP GLOBAL ---
        window.router = Router;
        DataService.initApp();
        AuthService.init();

    </script>
</body>
</html>
